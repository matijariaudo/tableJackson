<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#000" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-iconic-font/2.2.0/css/material-design-iconic-font.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  
  <title>Document</title>
  <style>
  body{
    background-color: #e7e7e7;
    color:#525252;
    font-family: 'Fredoka', sans-serif;
  }
  /* Estilos para el botón de carga personalizado */
  .custom-file-upload {
    border: 1px solid #ccc;
    display: inline-block;
    padding: 6px 12px;
    cursor: pointer;
    background-color: #14958e;
    color:#FFF;
    border-radius: 4px;
    transition: background-color 0.3s ease;
  }

  .custom-file-upload:hover {
    background-color: #e0e0e0;
  }

  .fixed-bottom{
    background-color: #301e9f;
    color:#FFF;
    text-align: center;
  }
  .fixed-bottom .nav_div{
    border:1px solid #87a4df;
    border-width: 0px 1px 0px 0px;
  }

  table td,th{
    padding: 3px;
    font-size: .8em;
    margin:0px
  }

  thead{
    background-color: #686868;
    color:#000000;
  }
  td{
   
    color:#FFF ;
  }  
  th,td{border: 1px solid #FFF;
    border-width: 0px 0px 0px 1px;
    white-space: nowrap;
  }
  tr{
    border: 0px solid #000;
  }

  /* Ocultar el input file */
  input[type="file"] {
    display: none;
  }
  #image-container {
            width: 100%;
            height: 60vh;
            overflow: hidden;
            border-radius: 20px;
        }
        #image {
            max-width: 100%;
            display: block;
            margin: 0 auto;
        }
  .table-div
  .choosen{
    border-radius: 10px;
    padding:5px 30px;
    margin-top: 5px;
    margin-left: 5px;
    border: 0px;
    
  }
  .capa{
    padding: 0px;background: #f2f2f2;height: 100vh;margin: 0px;padding: 10px;
    overflow-y: auto;
  }
  </style>
</head>
<body>
  <div class="navbar fixed-top row capa_no capa_10_no capa_100_no capa_101_no capa_0_no" style="padding: 10px 0px;background-color: #000000;color:#FFF;margin: 0px;text-align: center;">
    <div class="col-12 p-2">
      <img src="img/logo.webp" alt="" style="width: 30vw;">
    </div>
    <div class="col-10 p-2">
      <input type="text" class="form-control" onclick="capa(2);$('#txt_buscar').focus().val('')"placeholder="Product, code or supplier.." style="width: 100%;background-color:rgba(255,255,255,.12);border:0px;border-radius: 100px;color:#FFCC00;">
    </div>
    <div class="col-2 p-2">
      <button class="btn" style="background-color: #7c7c7c;border-radius: 100px;padding: 5px 12px;" onclick="$('#inputImage').click()">+</button>
    </div>
  </div>
  <div class="container-fluid"  style="padding: 0px;;margin: 0px;padding: 0px;">
    <div class="capa capa_0 row" style="background: #000;text-align: center;">
    <div class="offset-4 col-4" style="margin-top: 30vh; color:#FFF"><img src="https://blog.roberthallam.org/wp-content/uploads/2022/09/loading-win98-transparent.gif" style="width: 100%;filter: invert(1);"><br>Loading..</div>
    </div>
    <div class="capa capa_1 row" style="padding-top: 120px;">
      <div class="col-12" id="products">
        <button class="btn" data="1" style="background-color: #301e9f;color:#FFF;margin-bottom: 10px;" onclick="uploadCroppedImage2()"><i class="zmdi zmdi-plus" ></i> Simular</button>
            
        saddas
      </div>
    </div>
    <div class="capa capa_100 row" style="padding-top: 30px;background-color: #000;color:#FFF">
      <div class="container">
          <input type="file" class="form-control mt-3 mb-3" id="inputImage">
        <div class="col-12" style="margin-top: 20px;">
          <div id="result" class="mt-3">
            <img id="croppedImage" src="" alt="Cropped Image" class="img-fluid" style="max-width: 100%;display: none;border: 2px solid #FFF;">
        </div>
        </div>      
        <div class="col-12 " id="upload_choosen" style="padding: 0px 0px 10px 0px;display: none;">
          <h3 style="margin-top: 20px; text-align: center;">Match columns & data</h3>
          <input type="checkbox" id="headers_check" onchange="print_table()">Headers
          <div class="table-responsive"  id="table_read" style="max-height: 60vh;border:2px solid #FFF;padding:0px;border-radius: 10px;"></div>
          <div class="options col-12" style="text-align: left;">
          <div class="col-12" style="padding: 30px ;text-align: center;">
            <button class="btn btn-danger" data="1" style="margin-bottom: 10px;" onclick="capa(1)">Cancel</button>
            <button class="btn btn-success" data="1" style="margin-bottom: 10px;" onclick="createForm()">Next Step</button>
          </div>
          </div>
          <div class="col-12" style="padding:0px;font-size: .6em;margin-bottom: 70px;">User Id: <b class="user_id"></b> </div>  
        </div>
      </div>
    </div>
    <div class="capa capa_101 row" style="padding-top: 30px;background-color: #000;color:#FFF">
      <div class="col-12">
      <h3 style="margin: 20px 0px; text-align: center;">Upload Products</h3>
      <div class="col-12" style="border:1px solid #FFF;border-width: 2px 0px 2px 0px;padding-top: 30px;">
        Supplier: <input type="text"  id="form_suplier" style="background: none;border:1px solid #FFF;border-radius: 4px;color:#FFF"><br><br>
        Date: <input type="datetime-local" id="form_date" style="background: none;border:1px solid #FFF;border-radius: 4px;margin-bottom: 30px;color: #FFF;">
      </div>
      <div class="col-12" id="div_form"></div>
      <div class="col-12" style="padding: 30px ;text-align: center;">
        <button class="btn btn-danger" data="1" style="margin-bottom: 10px;" onclick="capa(100)">Go Back</button>
        <button class="btn btn-success" data="1" style="margin-bottom: 10px;" id="enviar_form">Send Form</button>
      </div>
      
      </div>
    </div>
    <div class="capa capa_10 row" style="margin: 0px;padding: 50px 0px 0px 0px;background-color: #000;text-align: center;">
      <div class="col-12">
        <div id="image-container" style="border: 2px solid #FFF;">
            <img id="image" src="" style="display: none;" alt="Image for cropping and rotating">
        </div>
      </div>
      <div class="mt-3 text-center">
        <button onclick="capa(1)" class="btn btn-danger ">Delete</button> <button id="crop" class="btn btn-success">Continue</button>
      </div>
    </div>
    <div class="capa capa_2 row" style="margin: 0px;padding: 0px;text-align: center;">
        
        <div class="row" style="padding: 10px;background-color: #000;margin: 0px;">
          <input type="text" onfocus="$(this).val('');$(this).keyup()" autocomplete="off" class="form-control" id="txt_buscar" placeholder="Song name.." style="width: 100%;background-color:rgba(255,255,255,.12);border:0px;border-radius: 100px;color:#FFCC00;">
        </div>
        <div class="co-12 songs" style="padding:30px 20px 100px 20px">

        </div>
    </div>
    <div class="capa capa_3 row" style="padding: 40px 30px;background: #000;min-height: 100%;">
      <div class="col-12">
      <center><img src="img/loading.gif" style="width: 90px;" id="img_show_loading"></center>
      <img src="" alt="" id="img_show" onload="$(this).show();$('#img_show_loading').hide()" style="width: 100%;border:1px solid #FFF">
      <button class="btn" onclick="capa(1)" style="border-radius:100px;background:rgb(100,100,100);color:rgba(200,200,200);margin-top:30px">
        <i class="zmdi zmdi-arrow-left"></i>
        Go back
      </button>
    </div>
    </div>
  </div>

  <nav class="navbar fixed-bottom " style="padding: 0px;box-shadow: -2px 5px 30px -5px rgba(66, 66, 66, 0.75);display: none;">
    <div class="col-6 nav_div nav_div_1" onclick="capa(1)" style="padding: 20px 10px;"><i class="zmdi zmdi-format-list-bulleted"></i> PRODUCTS</div>
    <div class="col-6 nav_div nav_div_2" onclick="capa(2)" style="padding: 20px 10px"><i class="zmdi zmdi-collection-music"></i> SUPPLIERS</div>
  </nav>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>

    function capa(i){
      $(".capa").hide();
      $(".capa_"+i).show();
      $(".capa_no").show();
      $(".capa_"+i+"_no").hide();
      $('.nav_div').css('color','#FFF');
      $(".nav_div_"+i).css('color','#FFCC00');
      console.log("capa",i)
    }
    
    capa(0)
    
    let cropper;
    const image = document.getElementById('image');
    const inputImage = document.getElementById('inputImage');
    const croppedImage = document.getElementById('croppedImage');

    inputImage.addEventListener('change', function(event) {
        capa(10)
        $("#image").show()
        const files = event.target.files;
        if (files && files.length > 0) {
            const file = files[0];
            const url = URL.createObjectURL(file);
            image.src = url;
            if (cropper) {
                cropper.destroy();
            }
            cropper = new Cropper(image, {
                viewMode: 1,
                dragMode: 'move',
                autoCropArea: 1,
                responsive: true,
                restore: true,
                movable: true,
                rotatable: true,
                scalable: true,
                zoomable: true,
                zoomOnTouch: true,
                zoomOnWheel: true,
                cropBoxResizable: true,
            });
        }
    });

    document.getElementById('crop').addEventListener('click', function() {
        const canvas = cropper.getCroppedCanvas();
        croppedImage.src = canvas.toDataURL();
        canvas.toBlob(function(blob) {
            uploadCroppedImage(blob);
        });
    });


    tableData=[]
    function uploadCroppedImage(blob){
        capa(0)
        const formData = new FormData();
        formData.append('archivo', blob);
        $.ajax({
        url: '/upload', // URL del servidor donde se enviarán los datos
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            console.log(response)
            const rta=response.contenido;
            tableData=rta;
            capa(100)
            $("#headers_check").prop('checked',false)
            print_table();
            $("#croppedImage").show();
            $("#upload_choosen").show()
            //initsearch()
            
        },
        error: function(error) {
            // Manejar errores si ocurren
        }
        });
    } 
    
    function uploadCroppedImage2(){
        capa(0)
        $.ajax({
        url: '/upload2', // URL del servidor donde se enviarán los datos
        type: 'POST',
        success: function(response) {
            console.log(response)
            const rta=response.contenido;
            tableData=rta;
            console.log(tableData)
            capa(100)
            $("#headers_check").prop('checked',false)
            print_table();
            $("#croppedImage").hide();
            $("#upload_choosen").show()
            //initsearch()
            
        },
        error: function(error) {
            // Manejar errores si ocurren
        }
        });
    } 
    
    const print_table=()=>{
      cabecera=$("#headers_check").prop('checked');
      $("#table_read").html("");
      html="";cabecera?limit=0:limit=1000
      tableData.forEach(t => {
      html+=`<table class="ui celled table" style="margin:0px">`;
      qty=t[0].length;
      cab="<thead style='background:#FFF;color:#000'><tr>"
      for (let i = 0; i < qty; i++) {
        cab+=`<th><select class="choosen_col" style="min-width:60px"><option Value="NO">Choose</option><option value="qty">Quantity</option><option value="code">Code</option><option value="price">Price</option><option value="pricet">Total Price</option><option value="product">Product</option></select></th>` 
      }
      cab+=`</tr></thead>`;
      html+=cab;
      console.log(t)
      t.forEach((c,i) => {
         console.log(c)
          columna=""
          i==limit?columna+=`<thead><tr>`:html+=`<tr>`;
          c?.forEach(r => {
          i==limit?columna+=`<th>${r}</th>`:columna+=`<td>${r}</td>`;
          });
          i==limit?columna+=`</tr></thead>`:html+=`</tr>`;
          html+=columna;
      });
      html+=`</table>`;
      });
      $("#table_read").html(html);
    }

    function createForm(){
      const cabecera=$("#headers_check").prop('checked');
      $("#div_form").html("");
      html="";cabecera?limit=0:limit=1000
      n=0;pos={}
      $(".choosen_col").each(function(e){
        pos[$(this).val()]=n;
        n++;
      })

      tableData.forEach(t => {
      html+=`<div class="row p-2">`;
      p=0;
      t.forEach((c,i) => {
          console.log("AAA",c)
          if(i!=limit && c){
            html+=`
            <div class="col-1" style="padding:2px"><input  id="valid_${p}" type="checkbox" checked  style="max-width:100%;margin-top:30px;color:#FFF;background:rgb(255,255,255,.1);border:1px solid #FFF;border-radius:3px"></div>
            <div class="col-11"style="padding:2px">Product<br><input id="product_${p}"  type="text" style="color:#FFF;background:none;border:0px;color:#FFCC00;width:100%" value="${c[pos.product] || ""}" style="max-width:100%;min-width:100%"></div>
            <div class="col-3" style="padding:2px">Qty<br><input  id="qty_${p}" type="text" value="${c[pos.qty] || ""}"  style="max-width:100%;color:#FFF;background:rgb(255,255,255,.1);border:1px solid #FFF;border-radius:3px"></div>
            <div class="col-3" style="padding:2px">Code<br><input id="code_${p}" type="text" value="${c[pos.code] || ""}"  style="max-width:100%;color:#FFF;background:rgb(255,255,255,.1);border:1px solid #FFF;border-radius:3px"></div>
            <div class="col-3" style="padding:2px">Price<br><input  id="price_${p}" type="text" value="${c[pos.price] || ""}"  style="max-width:100%;color:#FFF;background:rgb(255,255,255,.1);border:1px solid #FFF;border-radius:3px"></div>
            <div class="col-3" style="padding:2px">Total<br><input  id="pricet_${p}" type="text" value="${c[pos.pricet] || ""}"  style="max-width:100%;color:#FFF;background:rgb(255,255,255,.1);border:1px solid #FFF;border-radius:3px"></div>
            `
          p++;
          }
      });
      html+=`</div>`;
      });
      $("#div_form").html(html);
      $("#div_form").append(`<input type='hidden' id="total_reg" value='${p}'>`);
      capa(101)
      $("#form_date").val(hora())
    }

    function hora(){
      // Obtener la fecha actual
      let now = new Date();
      // Formatear la fecha en 'YYYY-MM-DDTHH:MM'
      let year = now.getFullYear();
      let month = String(now.getMonth() + 1).padStart(2, '0');
      let day = String(now.getDate()).padStart(2, '0');
      let hours = String(now.getHours()).padStart(2, '0');
      let minutes = String(now.getMinutes()).padStart(2, '0');

      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    $("#enviar_form").on('click',()=>{
       data=[]
       for (let i = 0; i < $('#total_reg').val(); i++) {
        if($("#valid_"+i).prop('checked') && $("#product_"+1).val().trim()!=""){
        data.push({product:$('#product_'+i).val(),qty:$('#qty_'+i).val(),code:$('#code_'+i).val(),price:$('#price_'+i).val(),pricet:$('#pricet_'+i).val()})
        }
      }
      console.log({reg:data,date:$("#form_date").val(),suplier:$("#form_suplier").val()})
      $.ajax({
        url: '/uploadproduct', // URL del servidor donde se enviarán los datos
        type: 'POST',
        data: JSON.stringify({reg:data,date:$("#form_date").val(),suplier:$("#form_suplier").val()}),
        contentType: 'application/json',
        success: function(response) {
          alert(1)
        }})
    })

    const getRegistros=()=>{
       data=[]
       for (let i = 0; i < $('#total_reg').val(); i++) {
        if($("#valid_"+i).prop('checked') && $("#product_"+1).val().trim()!=""){
        data.push({product:$('#product_'+i).val(),qty:$('#qty_'+i).val(),code:$('#code_'+i).val(),price:$('#price_'+i).val(),pricet:$('#pricet_'+i).val()})
        }
      }
      console.log({reg:data,date:$("#form_date").val(),suplier:$("#form_suplier").val()})
      $.ajax({
        url: '/getproduct', // URL del servidor donde se enviarán los datos
        type: 'POST',
        data: JSON.stringify({}),
        contentType: 'application/json',
        success: function(r) {
          html=``
          r.data.forEach(e => {
            html+=`<div class="col-12">
              <div class="col-12" style="background:#FFF;border-radius:10px;padding:10px;margin-top:5px;border:1px solid #333">
                <h5>${e.product} <b>(x${e.qty})</b></h5>
                <p style="margin:0px"><b>Code: </b>${e.code} <b>Supplier: </b>${e.suplier}</p>
                <p style="margin:0px"><b>Pricing: </b>${e.price} <b>Total pricing: </b>${e.pricet}</p>
                
              </div>
              </div>`
          });
          $("#products").html(html)
        }})
    }
    getRegistros()



    //Setting filtros
    btn_filter=localStorage.getItem('btn_filter');
    if(!btn_filter){btn_filter=3;}
    $('.btn_filter').css('background','#4e4e4e');$('#btn_filter_'+btn_filter).css('background','#FFCC00');
    $('.btn_filter').on("click",function(){ 
      $('.btn_filter').css('background','#4e4e4e');
      $(this).css('background','#FFCC00');
      btn_filter=$(this).attr("data")
      initsearch();
    })
    //Setting user
    user_id=localStorage.getItem('user_id');
    if(!user_id){user_id=generarCodigo(30);localStorage.setItem('user_id',user_id);}
    $(".user_id").html(user_id)

    capa(1)
    function compararCadenas(str1, str2) {
      const set1 = new Set(str1.split(''));
      coin=0;total=0;
      set1.forEach(e => {
        c1=str1.split('').filter(a=>a==e).length;
        c2=str2.split('').filter(a=>a==e).length;
        max=Math.max(c1,c2);
        dif=Math.abs(c1-c2);
        total+=max;
        coin+=(max-dif);
        
      });
      rta=coin/total;
      //console.log()
      return rta;
    }

    function act(ids,valor){
      var settings = {
      "url": "/cambios",
      "method": "POST",
      "timeout": 0,
      "headers": {
        "Content-Type": "application/json"
      },
      "data": JSON.stringify({ids,valor}),
    };

    $.ajax(settings).done(function (response) {
      console.log(response);
      initsearch()
    });
    }

    let dejodeescribir;
    $("#txt_buscar").on("keyup",function () {
        txt=$(this).val();
        clearInterval(dejodeescribir)
        dejodeescribir=setInterval(()=>{
          $(".songs_list").show()
          $(".songs_list").each(function(s){
            if($(this).html().toLowerCase().indexOf(txt.toLowerCase())<0){
              $(this).hide()
            }
          });
          clearInterval(dejodeescribir)
        },300)
     })


     function generarCodigo(longitud) {
      const caracteres = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      let codigo = "";

      for (let i = 0; i < longitud; i++) {
        const caracterAleatorio = caracteres.charAt(Math.floor(Math.random() * caracteres.length));
        codigo += caracterAleatorio;
      }

      return codigo;
    }
    </script>
</body>
</html>
